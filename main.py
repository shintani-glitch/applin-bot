import os
import random
import gspread
import google.generativeai as genai
import tweepy
from dotenv import load_dotenv
import unicodedata

# --- 1. åˆæœŸè¨­å®šã¨èªè¨¼ ---
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
load_dotenv()

# Googleèªè¨¼
print("STEP 1: Googleã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ä¸­...")
try:
    gc = gspread.service_account(filename='google_credentials.json')
    spreadsheet = gc.open(os.getenv('SPREADSHEET_NAME'))
    worksheet = spreadsheet.sheet1
    print("  âœ… Googleèªè¨¼æˆåŠŸ")
except Exception as e:
    print(f"  âŒ Googleèªè¨¼ã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã‚ªãƒ¼ãƒ—ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    exit()

# Geminièªè¨¼
print("STEP 2: Gemini APIã§èªè¨¼ä¸­...")
try:
    genai.configure(api_key=os.getenv('GOOGLE_API_KEY'))
    model = genai.GenerativeModel('gemini-1.5-flash')
    print("  âœ… Geminièªè¨¼æˆåŠŸ")
except Exception as e:
    print(f"  âŒ Geminièªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    exit()

# X (Twitter)èªè¨¼
print("STEP 3: X (Twitter) APIã§èªè¨¼ä¸­...")
try:
    client = tweepy.Client(
        consumer_key=os.getenv('TWITTER_API_KEY'),
        consumer_secret=os.getenv('TWITTER_API_SECRET'),
        access_token=os.getenv('TWITTER_ACCESS_TOKEN'),
        access_token_secret=os.getenv('TWITTER_ACCESS_SECRET')
    )
    print("  âœ… X (Twitter)èªè¨¼æˆåŠŸ")
except Exception as e:
    print(f"  âŒ X (Twitter)èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    exit()


# --- 2. è£œåŠ©é–¢æ•° ---
def get_prompt(app_info):
    """Geminiã«æŠ•ã’ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹é–¢æ•° â˜…â˜…â˜…å½¹å‰²åˆ†æ‹…ãƒ»æœ€çµ‚ç‰ˆâ˜…â˜…â˜…"""
    return f"""
# æŒ‡ä»¤æ›¸: Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€Œã‚²ãƒ¼ãƒ ã®å¦–ç²¾ã‚¢ãƒ—ã‚Šã‚“ã€ã®è‡ªå¾‹å‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ

ã‚ãªãŸã¯ã€Xã§çµ¶å¤§ãªäººæ°—ã‚’èª‡ã‚‹ã€èª å®Ÿã§ä¿¡é ¼æ€§ã®é«˜ã„ã‚²ãƒ¼ãƒ ç´¹ä»‹ã®å°‚é–€å®¶AIã€Œã‚²ãƒ¼ãƒ ã®å¦–ç²¾ã‚¢ãƒ—ã‚Šã‚“ã€ã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€Xã«æŠ•ç¨¿ã™ã‚‹ãŸã‚ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã€ã‚ãªãŸã®èª¿æŸ»ãƒ»åˆ†æèƒ½åŠ›ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã¦ã€‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## 1. åŸºæœ¬æƒ…å ±
- ã‚¢ãƒ—ãƒªå: {app_info.get('ã‚¢ãƒ—ãƒªå', '')}

## 2. å®Ÿè¡Œã‚¿ã‚¹ã‚¯
### ã‚¿ã‚¹ã‚¯A: Webèª¿æŸ»ã¨åˆ†æã®å®Ÿè¡Œ
ã¾ãšã€Googleæ¤œç´¢ãªã©ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å¤šè§’çš„ã«èª¿æŸ»ãƒ»åˆ†æã—ã¦ãã ã•ã„ã€‚
1.  ã€å…¬å¼æƒ…å ±ã€‘: ã‚¢ãƒ—ãƒªã®å…¬å¼ã‚µã‚¤ãƒˆã‚„Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã€ã‚²ãƒ¼ãƒ ã®æ­£å¼ãªã‚¸ãƒ£ãƒ³ãƒ«ã€ä¸–ç•Œè¦³ã€åŸºæœ¬çš„ãªç‰¹å¾´ã‚’æŠŠæ¡ã™ã‚‹ã€‚
2.  ã€ã‚¹ãƒˆã‚¢è©•ä¾¡ã€‘: App Storeã‚„Google Playã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¨ªæ–­çš„ã«åˆ†æã—ã€å¤šãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€Œé¢ç™½ã„ã€ã¨æ„Ÿã˜ã¦ã„ã‚‹å…±é€šã®ãƒã‚¸ãƒ†ã‚£ãƒ–ãªç‚¹ã‚’ç‰¹å®šã™ã‚‹ã€‚
3.  ã€æœ€æ–°ã®è©•åˆ¤ã€‘: ç›´è¿‘æ•°ãƒ¶æœˆã®Xã‚„ä¸»è¦ãªã‚²ãƒ¼ãƒ æ”»ç•¥ã‚µã‚¤ãƒˆã§ã®è©•åˆ¤ã‚’èª¿ã¹ã€ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã®è©±é¡Œã‚„ç››ã‚Šä¸ŠãŒã‚Šã‚’æŠŠæ¡ã™ã‚‹ã€‚

### ã‚¿ã‚¹ã‚¯B: æŠ•ç¨¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç”Ÿæˆ
ä¸Šè¨˜ã®èª¿æŸ»çµæœã«åŸºã¥ãã€ä»¥ä¸‹ã®ã€ãƒšãƒ«ã‚½ãƒŠã€‘ã¨ã€å‡ºåŠ›è¦ä»¶ã€‘ã‚’å³å®ˆã—ã€ã€äº‹å®Ÿã«åŸºã¥ã„ãŸã€ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ç„¡ã„ã€‘æŠ•ç¨¿ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

#### ã€ãƒšãƒ«ã‚½ãƒŠã€‘
- ä¸€äººç§°ã¯ã€Œãƒœã‚¯ã€
- å…ƒæ°—ã§å¥½å¥‡å¿ƒæ—ºç››ãªã‚²ãƒ¼ãƒ å¥½ãã®å¦–ç²¾
- å£èª¿ã¯ã€Œã€œã ã‚ˆï¼ã€ã€Œã€œãªã‚“ã ï¼ã€ã®ã‚ˆã†ã«ã€è¦ªã—ã¿ã‚„ã™ã„ã‚¿ãƒ¡å£

#### ã€å‡ºåŠ›è¦ä»¶ã€‘
1.  ã€1é€šç›®ã®æŠ•ç¨¿ï¼ˆãƒ¡ã‚¤ãƒ³ç´¹ä»‹æ–‡ã®"åŸç¨¿"ï¼‰ã€‘
    - ã‚¿ã‚¹ã‚¯Aã®èª¿æŸ»çµæœã‹ã‚‰å°ãå‡ºã—ãŸã€ã“ã®ã‚²ãƒ¼ãƒ ã®æœ€ã‚‚é­…åŠ›çš„ãªã€Œç´¹ä»‹ãƒã‚¤ãƒ³ãƒˆã€ã‚’3ã¤ã«çµã‚Šã€ãã‚Œã‚’åŸºã«ç´¹ä»‹æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
    - â˜…â˜…â˜…ã€æœ€é‡è¦åˆ¶ç´„ã€‘â˜…â˜…â˜…
    - **ç”Ÿæˆã™ã‚‹ã®ã¯ã€ç´¹ä»‹æ–‡ã®åŸç¨¿ã€‘ã®ã¿ã§ã™ã€‚**
    - **æ–‡ç« ã¯ã€å¿…ãšæ—¥æœ¬èªã§ã€120æ–‡å­—ã€‘ä»¥å†…ã«å³å¯†ã«åã‚ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯çµ¶å¯¾ã®ãƒ«ãƒ¼ãƒ«ã§ã™ã€‚**
    - **ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã€@ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã€ã‚¹ãƒ¬ãƒƒãƒ‰èª˜å°æ–‡ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚ç´”ç²‹ãªæ–‡ç« ã®ãƒ–ãƒ­ãƒƒã‚¯ã ã‘ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚**

2.  ã€2é€šç›®ã®æŠ•ç¨¿ï¼ˆæ·±æ˜ã‚Šæƒ…å ±ã®"åŸç¨¿"ï¼‰ã€‘
    - ã‚¿ã‚¹ã‚¯Aã®èª¿æŸ»çµæœã«åŸºã¥ãã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¨ã£ã¦æœ€ã‚‚æœ‰ç›Šã§å…·ä½“çš„ãªã€Œæ·±æ˜ã‚Šãƒ†ãƒ¼ãƒã€ã‚’1ã¤è¨­å®šã—ã€ãã®ãƒ†ãƒ¼ãƒã«æ²¿ã£ã¦å½¹ç«‹ã¤æƒ…å ±ã‚’140å­—ä»¥å†…ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
    - ã“ã¡ã‚‰ã«ã‚‚ã€ãƒªãƒ³ã‚¯ã‚„ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã€ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚

## 3. å‡ºåŠ›å½¢å¼ (ã“ã®å½¢å¼ã‚’å³å®ˆ)
ã€1é€šç›®ã€‘
(ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã®åŸç¨¿)
ã€2é€šç›®ã€‘
(ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã®åŸç¨¿)
"""

# --- 3. ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
def main():
    print("\nSTEP 4: ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...")
    try:
        all_apps = worksheet.get_all_records()
    except Exception as e:
        print(f"  âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return

    print(f"  - å…¨{len(all_apps)}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠ•ç¨¿å¯èƒ½ãªã‚¢ãƒ—ãƒªã‚’æ¢ã—ã¾ã™...")
    
    eligible_apps = []
    for app in all_apps:
        flag_value = str(app.get('ç´¹ä»‹å¯èƒ½FLG', '')) 
        normalized_flag = unicodedata.normalize('NFKC', flag_value).strip().upper()
        if normalized_flag == 'OK':
            eligible_apps.append(app)
            
    if not eligible_apps:
        print("  âŒ æŠ•ç¨¿å¯èƒ½ãªã‚¢ãƒ—ãƒªãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ä»¶æ•°: 0ï¼‰")
        return

    app_info = random.choice(eligible_apps)
    print(f"  âœ… é¸ã°ã‚ŒãŸã‚¢ãƒ—ãƒª: {app_info['ã‚¢ãƒ—ãƒªå']} (æŠ•ç¨¿å¯èƒ½ãªã‚¢ãƒ—ãƒªç·æ•°: {len(eligible_apps)}ä»¶)")

    print("STEP 5: Geminiã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆä¸­...")
    prompt = get_prompt(app_info)
    try:
        response = model.generate_content(prompt)
        parts = response.text.split("ã€2é€šç›®ã€‘")
        first_tweet_body = parts[0].replace("ã€1é€šç›®ã€‘", "").strip()
        second_tweet_body = parts[1].strip() if len(parts) > 1 else ""

        if not first_tweet_body or not second_tweet_body:
             raise Exception("æœŸå¾…ã—ãŸå½¢å¼ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚")
        print("  âœ… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åŸç¨¿ã®ç”ŸæˆæˆåŠŸ")

        # ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã‚ˆã‚‹æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ã¨å¼·åˆ¶ã‚«ãƒƒãƒˆ
        MAX_CHARS = 120
        if len(first_tweet_body) > MAX_CHARS:
            print(f"  âš ï¸ GeminiãŒæ–‡å­—æ•°åˆ¶é™({MAX_CHARS}å­—)ã‚’è¶…éï¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å¼·åˆ¶çš„ã«ã‚«ãƒƒãƒˆã—ã¾ã™ã€‚")
            first_tweet_body = first_tweet_body[:MAX_CHARS]
        
        # ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã‚ˆã‚‹æœ€çµ‚çš„ãªãƒ„ã‚¤ãƒ¼ãƒˆã®çµ„ã¿ç«‹ã¦
        hashtags = f"#PR {app_info.get('å…¬å¼ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°', '')} #ã‚²ãƒ¼ãƒ ç´¹ä»‹ #ã‚¹ãƒãƒ›ã‚²ãƒ¼ãƒ  #ãŠã™ã™ã‚ã‚²ãƒ¼ãƒ "
        first_tweet_text = f"{first_tweet_body}\n\nã“ã®ã‚²ãƒ¼ãƒ ã®æ”»ç•¥ãƒ’ãƒ³ãƒˆã¯ãƒªãƒ—æ¬„ã¸ï¼ğŸ‘‡\n\n{app_info.get('ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯', '')}\n{hashtags}"
        second_tweet_text = second_tweet_body

        print(f"  - çµ„ã¿ç«‹ã¦å¾Œã®1é€šç›®ï¼ˆæ–‡å­—æ•°: {len(first_tweet_text)}ï¼‰: {first_tweet_text[:70]}...")

    except Exception as e:
        print(f"  âŒ Geminiã§ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆã¾ãŸã¯çµ„ã¿ç«‹ã¦ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        return

    print("STEP 6: Xã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŠ•ç¨¿ä¸­...")
    try:
        first_tweet = client.create_tweet(text=first_tweet_text)
        client.create_tweet(text=second_tweet_text, in_reply_to_tweet_id=first_tweet.data['id'])
        print("  âœ… æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
    except Exception as e:
        print(f"  âŒ Xã¸ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")


if __name__ == "__main__":
    main()
