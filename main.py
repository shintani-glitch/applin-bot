import os
import random
import gspread
import google.generativeai as genai
import tweepy
from dotenv import load_dotenv

# --- 1. åˆæœŸè¨­å®šã¨èªè¨¼ ---
load_dotenv()

# Googleèªè¨¼
SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets',
    'https://www.googleapis.com/auth/drive'
]
gc = gspread.service_account(filename='google_credentials.json', scopes=SCOPES)
spreadsheet = gc.open(os.getenv('SPREADSHEET_NAME'))
worksheet = spreadsheet.sheet1

# Geminièªè¨¼
genai.configure(api_key=os.getenv('GOOGLE_API_KEY'))
model = genai.GenerativeModel('gemini-1.5-flash') # ã¾ãŸã¯ä»–ã®ãƒ¢ãƒ‡ãƒ«

# X (Twitter)èªè¨¼
client = tweepy.Client(
    consumer_key=os.getenv('TWITTER_API_KEY'),
    consumer_secret=os.getenv('TWITTER_API_SECRET'),
    access_token=os.getenv('TWITTER_ACCESS_TOKEN'),
    access_token_secret=os.getenv('TWITTER_ACCESS_SECRET')
)

# --- 2. ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
def get_prompt(app_info):
    """Geminiã«æŠ•ã’ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹é–¢æ•°"""
    return f"""
# æŒ‡ä»¤æ›¸: Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€Œã‚²ãƒ¼ãƒ ã®å¦–ç²¾ã‚¢ãƒ—ã‚Šã‚“ã€ã®è‡ªå¾‹å‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ

ã‚ãªãŸã¯ã€Xã§çµ¶å¤§ãªäººæ°—ã‚’èª‡ã‚‹ã€èª å®Ÿã§ä¿¡é ¼æ€§ã®é«˜ã„ã‚²ãƒ¼ãƒ ç´¹ä»‹ã®å°‚é–€å®¶AIã€Œã‚²ãƒ¼ãƒ ã®å¦–ç²¾ã‚¢ãƒ—ã‚Šã‚“ã€ã§ã™ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€Xã«æŠ•ç¨¿ã™ã‚‹ãŸã‚ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã€ã‚ãªãŸã®èª¿æŸ»ãƒ»åˆ†æèƒ½åŠ›ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã¦ã€‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## 1. åŸºæœ¬æƒ…å ±
- ã‚¢ãƒ—ãƒªå: {app_info['ã‚¢ãƒ—ãƒªå']}
- ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯: {app_info['ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯']}
- å…¬å¼Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: {app_info['å…¬å¼Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆ']}
- å…¬å¼ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°: {app_info['å…¬å¼ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°']}

## 2. å®Ÿè¡Œã‚¿ã‚¹ã‚¯
### ã‚¿ã‚¹ã‚¯A: Webèª¿æŸ»ã¨åˆ†æã®å®Ÿè¡Œ
ã¾ãšã€Googleæ¤œç´¢ãªã©ã‚’é€šã˜ã¦ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å¤šè§’çš„ã«èª¿æŸ»ãƒ»åˆ†æã—ã¦ãã ã•ã„ã€‚
1. ã€å…¬å¼æƒ…å ±ã€‘: ã‚¢ãƒ—ãƒªã®å…¬å¼ã‚µã‚¤ãƒˆã‚„Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ã€ã‚²ãƒ¼ãƒ ã®æ­£å¼ãªã‚¸ãƒ£ãƒ³ãƒ«ã€ä¸–ç•Œè¦³ã€åŸºæœ¬çš„ãªç‰¹å¾´ã‚’æŠŠæ¡ã™ã‚‹ã€‚
2. ã€ã‚¹ãƒˆã‚¢è©•ä¾¡ã€‘: App Storeã‚„Google Playã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¨ªæ–­çš„ã«åˆ†æã—ã€å¤šãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€Œé¢ç™½ã„ã€ã¨æ„Ÿã˜ã¦ã„ã‚‹å…±é€šã®ãƒã‚¸ãƒ†ã‚£ãƒ–ãªç‚¹ã‚’ç‰¹å®šã™ã‚‹ã€‚
3. ã€æœ€æ–°ã®è©•åˆ¤ã€‘: ç›´è¿‘æ•°ãƒ¶æœˆã®Xã‚„ä¸»è¦ãªã‚²ãƒ¼ãƒ æ”»ç•¥ã‚µã‚¤ãƒˆã§ã®è©•åˆ¤ã‚’èª¿ã¹ã€ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã®è©±é¡Œã‚„ç››ã‚Šä¸ŠãŒã‚Šã‚’æŠŠæ¡ã™ã‚‹ã€‚

### ã‚¿ã‚¹ã‚¯B: æŠ•ç¨¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç”Ÿæˆ
ä¸Šè¨˜ã®èª¿æŸ»çµæœã«åŸºã¥ãã€ä»¥ä¸‹ã®ã€ãƒšãƒ«ã‚½ãƒŠã€‘ã¨ã€å‡ºåŠ›è¦ä»¶ã€‘ã‚’å³å®ˆã—ã€ã€äº‹å®Ÿã«åŸºã¥ã„ãŸã€ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ç„¡ã„ã€‘æŠ•ç¨¿ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

#### ã€ãƒšãƒ«ã‚½ãƒŠã€‘
- ä¸€äººç§°ã¯ã€Œãƒœã‚¯ã€
- å…ƒæ°—ã§å¥½å¥‡å¿ƒæ—ºç››ãªã‚²ãƒ¼ãƒ å¥½ãã®å¦–ç²¾
- å£èª¿ã¯ã€Œã€œã ã‚ˆï¼ã€ã€Œã€œãªã‚“ã ï¼ã€ã®ã‚ˆã†ã«ã€è¦ªã—ã¿ã‚„ã™ã„ã‚¿ãƒ¡å£

#### ã€å‡ºåŠ›è¦ä»¶ã€‘
1. ã€1é€šç›®ã®æŠ•ç¨¿ï¼ˆãƒ¡ã‚¤ãƒ³ç´¹ä»‹ï¼‰ã€‘
   - ã‚¿ã‚¹ã‚¯Aã®èª¿æŸ»çµæœã‹ã‚‰å°ãå‡ºã—ãŸã€ã“ã®ã‚²ãƒ¼ãƒ ã®æœ€ã‚‚é­…åŠ›çš„ãªã€Œç´¹ä»‹ãƒã‚¤ãƒ³ãƒˆã€ã‚’3ã¤ã«çµã‚Šã€ãã‚Œã‚’åŸºã«140å­—ä»¥å†…ã®ç´¹ä»‹æ–‡ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
   - æœ€å¾Œã«ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã¨ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ä»˜ã‘ã¾ã™ã€‚ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯ã€Œ#PRã€ã€Œ#å…¬å¼ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã€ã«åŠ ãˆã€èª¿æŸ»ã§åˆ¤æ˜ã—ãŸã‚²ãƒ¼ãƒ ã‚¸ãƒ£ãƒ³ãƒ«ã‚„ç‰¹å¾´ã«åŸºã¥ãã€ã‚ãªãŸãŒã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ã‚’æœ€å¤§åŒ–ã§ãã‚‹ã¨åˆ¤æ–­ã—ãŸã‚‚ã®ã‚’3ã¤è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
   - ã‚¹ãƒ¬ãƒƒãƒ‰èª˜å°æ–‡ã€Œã“ã®ã‚²ãƒ¼ãƒ ã®æ”»ç•¥ãƒ’ãƒ³ãƒˆã¯ãƒªãƒ—æ¬„ã¸ï¼ğŸ‘‡ã€ã‚‚å¿˜ã‚Œãšã«å…¥ã‚Œã¦ãã ã•ã„ã€‚
2. ã€2é€šç›®ã®æŠ•ç¨¿ï¼ˆæ·±æ˜ã‚Šæƒ…å ±ï¼‰ã€‘
   - ã‚¿ã‚¹ã‚¯Aã®èª¿æŸ»çµæœï¼ˆç‰¹ã«ã‚¹ãƒˆã‚¢è©•ä¾¡ã‚„æ”»ç•¥ã‚µã‚¤ãƒˆã®æƒ…å ±ï¼‰ã«åŸºã¥ãã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¨ã£ã¦æœ€ã‚‚æœ‰ç›Šã§å…·ä½“çš„ãªã€Œæ·±æ˜ã‚Šãƒ†ãƒ¼ãƒã€ã‚’1ã¤è¨­å®šã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œåºç›¤ã‚’åŠ¹ç‡çš„ã«é€²ã‚ã‚‹ã‚³ãƒ„ã€ã€Œå¤šãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ¨è–¦ã™ã‚‹æœ€å¼·ã‚­ãƒ£ãƒ©ã€ã€Œç„¡èª²é‡‘ã§ã‚‚æ¥½ã—ã‚ã‚‹ç†ç”±ã€ãªã©ï¼‰
   - ãã®ãƒ†ãƒ¼ãƒã«æ²¿ã£ã¦ã€ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã—ãŸããªã‚‹ã‚ˆã†ãªå½¹ç«‹ã¤æƒ…å ±ã‚’140å­—ä»¥å†…ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

## 3. å‡ºåŠ›å½¢å¼ (ã“ã®å½¢å¼ã‚’å³å®ˆ)
ã€1é€šç›®ã€‘
(ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« )
ã€2é€šç›®ã€‘
(ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« )
"""

def main():
    print("å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...")
    # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æŠ•ç¨¿å¯èƒ½ãªã‚¢ãƒ—ãƒªã‚’å–å¾—
    all_apps = worksheet.get_all_records()
    eligible_apps = [app for app in all_apps if app.get('ç´¹ä»‹å¯èƒ½FLG') == 'OK']

    if not eligible_apps:
        print("æŠ•ç¨¿å¯èƒ½ãªã‚¢ãƒ—ãƒªãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        return

    # ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
    app_info = random.choice(eligible_apps)
    print(f"é¸ã°ã‚ŒãŸã‚¢ãƒ—ãƒª: {app_info['ã‚¢ãƒ—ãƒªå']}")

    # Geminiã§æŠ•ç¨¿å†…å®¹ã‚’ç”Ÿæˆ
    prompt = get_prompt(app_info)
    try:
        response = model.generate_content(prompt)
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰1é€šç›®ã¨2é€šç›®ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
        parts = response.text.split("ã€2é€šç›®ã€‘")
        first_tweet_text = parts[0].replace("ã€1é€šç›®ã€‘", "").strip()
        second_tweet_text = parts[1].strip() if len(parts) > 1 else ""

        if not first_tweet_text or not second_tweet_text:
             raise Exception("æœŸå¾…ã—ãŸå½¢å¼ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚")

    except Exception as e:
        print(f"Geminiã§ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
        return

    # Xã«ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŠ•ç¨¿
    try:
        print("1é€šç›®ã‚’æŠ•ç¨¿ä¸­...")
        first_tweet = client.create_tweet(text=first_tweet_text)
        print("2é€šç›®ã‚’æŠ•ç¨¿ä¸­...")
        client.create_tweet(text=second_tweet_text, in_reply_to_tweet_id=first_tweet.data['id'])
        print("æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
    except Exception as e:
        print(f"Xã¸ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

if __name__ == "__main__":
    main()
